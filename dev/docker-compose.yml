services:
  node:
    image: ghcr.io/xmtp/node-go:main
    platform: linux/amd64
    environment:
      - GOWAKU-NODEKEY=8a30dcb604b0b53627a5adc054dbf434b446628d4bd1eccc681d223f0550ce67
    command:
      - --store.enable
      - --store.db-connection-string=postgres://postgres:xmtp@db:5432/postgres?sslmode=disable
      - --store.reader-db-connection-string=postgres://postgres:xmtp@db:5432/postgres?sslmode=disable
      - --mls-store.db-connection-string=postgres://postgres:xmtp@mlsdb:5432/postgres?sslmode=disable
      - --mls-validation.grpc-address=validation:50051
      - --api.enable-mls
      - --wait-for-db=30s
      - --api.authn.enable
    ports:
      - 5555:5555
      - 5556:5556
    depends_on:
      - db
      - mlsdb
      - validation

  validation:
    image: ghcr.io/xmtp/mls-validation-service:main
    platform: linux/amd64

  db:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: xmtp

  mlsdb:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: xmtp

  upload-service:
    build: ./uploadService
    ports:
      - 3000:3000

  history-server:
    image: ghcr.io/xmtp/message-history-server:main
    platform: linux/amd64
    ports:
      - 5558:5558

  notification_db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: notifications

  notification_server:
    image: xmtp/notifications-server:latest
    platform: linux/amd64
    depends_on:
      node:
        condition: service_healthy
      notification_db:
        condition: service_started
    command:
      - --xmtp-listener
      - --db-connection-string=postgres://postgres:notifications@notification_db:5432/postgres?sslmode=disable
      - --xmtp-address=node:5556 # Local Xmtp Node
      - --log-level=debug
      - --api
      - --api-port=8080

      # HTTP Delivery
      - --http-delivery
      - --http-delivery-address=${TEST_NOTIFICATION_DELIVERY_URL:-http://host.docker.internal:4000/api/v1/notifications/xmtp/handle-notification}
      # - --http-auth-header=${XMTP_NOTIFICATION_SECRET}

    ports:
      - 8080:8080
    extra_hosts:
      - "host.docker.internal:host-gateway"
